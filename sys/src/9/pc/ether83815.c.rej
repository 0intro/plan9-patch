--- sys/src/9/pc/ether83815.c	Sat Apr 17 18:59:32 2004
+++ sys/src/9/pc/ether83815.c	Sat Apr 17 18:59:32 2004
@@ -598,9 +598,13 @@
 	 * unmask interrupts and start the transmit side
 	 */
 	ctlr->rdr = malloc(ctlr->nrdr*sizeof(Des));
+	if (ctlr->rdr == nil)
+		error(Enomem);
 	last = nil;
 	for(des = ctlr->rdr; des < &ctlr->rdr[ctlr->nrdr]; des++){
 		des->bp = iallocb(Rbsz);
+		if (des->bp == nil)
+			error(Enomem);
 		des->cmdsts = Rbsz;
 		des->addr = PADDR(des->bp->rp);
 		if(last != nil)
@@ -687,13 +693,10 @@
 }
 
 static void
-softreset(Ctlr* ctlr, int resetphys)
+resetctlr(Ctlr *ctlr)
 {
-	int i, w;
+	int i;
 
-	/*
-	 * Soft-reset the controller
-	 */
 	csr32w(ctlr, Rcr, Rst);
 	for(i=0;; i++){
 		if(i > 100)
@@ -703,7 +706,27 @@
 			break;
 		delay(1);
 	}
+}
 
+static void
+shutdown(Ether* ether)
+{
+	Ctlr *ctlr = ether->ctlr;
+
+print("ether83815 shutting down\n");
+	csr32w(ctlr, Rcr, Rxd|Txd);	/* disable transceiver */
+	resetctlr(ctlr);
+}
+
+static void
+softreset(Ctlr* ctlr, int resetphys)
+{
+	int i, w;
+
+	/*
+	 * Soft-reset the controller
+	 */
+	resetctlr(ctlr);
 	csr32w(ctlr, Rccsr, Pmests);
 	csr32w(ctlr, Rccsr, 0);
 	csr32w(ctlr, Rcfg, csr32r(ctlr, Rcfg) | Pint_acen);
@@ -955,11 +978,11 @@
 	ether->transmit = transmit;
 	ether->interrupt = interrupt;
 	ether->ifstat = ifstat;
-	ether->multicast = multicast;
 
 	ether->arg = ether;
 	ether->promiscuous = promiscuous;
-
+	ether->multicast = multicast;
+	ether->shutdown = shutdown;
 	return 0;
 }
 
