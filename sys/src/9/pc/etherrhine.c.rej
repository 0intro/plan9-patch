--- sys/src/9/pc/etherrhine.c	Sat Apr 17 18:59:35 2004
+++ sys/src/9/pc/etherrhine.c	Sat Apr 17 18:59:34 2004
@@ -480,7 +480,8 @@
 	edev = arg;
 	ctlr = edev->ctlr;
 	ilock(&ctlr->lock);
-	iow8(ctlr, Rcr, ior8(ctlr, Rcr) | (enable ? RxProm : RxBcast));
+	iow8(ctlr, Rcr, (ior8(ctlr, Rcr) & ~(RxProm|RxBcast)) |
+		(enable ? RxProm : RxBcast));
 	iunlock(&ctlr->lock);
 }
 
@@ -543,17 +544,19 @@
 	return 0;
 }
 
+/* multicast already on, don't need to do anything */
 static void
-init(Ether *edev)
+multicast(void*, uchar*, int)
 {
-	Ctlr *ctlr;
-	MiiPhy *phy;
-	int i;
+}
 
-	ctlr = edev->ctlr;
+static void
+shutdown(Ether *edev)
+{
+	int i;
+	Ctlr *ctlr = edev->ctlr;
 
 	ilock(&ctlr->lock);
-
 	pcisetbme(ctlr->pci);
 
 	iow16(ctlr, Cr, ior16(ctlr, Cr) | Stop);
@@ -566,7 +569,20 @@
 	}
 	if (i == Nwait)
 		iprint("etherrhine: reset timeout\n");
+	iunlock(&ctlr->lock);
+}
 
+static void
+init(Ether *edev)
+{
+	Ctlr *ctlr;
+	MiiPhy *phy;
+	int i;
+
+	shutdown(edev);
+
+	ctlr = edev->ctlr;
+	ilock(&ctlr->lock);
 	iow8(ctlr, Eecsr, ior8(ctlr, Eecsr) | EeAutoLoad);
 	for (i = 0; i < Nwait; ++i) {
 		if ((ior8(ctlr, Eecsr) & EeAutoLoad) == 0)
@@ -598,6 +614,7 @@
 
 	iow16(ctlr, Imr, 0);
 	iow16(ctlr, Cr, ior16(ctlr, Cr) | Stop);
+	iow8(ctlr, Rcr, ior8(ctlr, Rcr) | RxMcast);
 
 	iunlock(&ctlr->lock);
 }
@@ -705,7 +722,8 @@
 	edev->transmit = transmit;
 	edev->ifstat = ifstat;
 	edev->promiscuous = promiscuous;
-
+	edev->multicast = multicast;
+	edev->shutdown = shutdown;
 	return 0;
 }
 
