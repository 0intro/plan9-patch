--- sys/src/cmd/vnc/kbdv.c	Mon Apr 19 00:16:00 2004
+++ sys/src/cmd/vnc/kbdv.c	Mon Apr 19 00:16:00 2004
@@ -1,5 +1,6 @@
 #include "vnc.h"
 #include <keyboard.h>
+#include "utf2ksym.h"
 
 enum {
 	Xshift = 0xFFE1,
@@ -88,7 +89,8 @@
 readkbd(Vnc *v)
 {
 	char buf[256], k[10];
-	int ctlfd, fd, kr, kn, ks, w, shift, ctl, alt;
+	ulong ks;
+	int ctlfd, fd, kr, kn, w, shift, ctl, alt;
 	Rune r;
 
 	snprint(buf, sizeof buf, "%s/cons", display->devdir);
@@ -143,6 +145,12 @@
 					shift = 1;
 					keyevent(v, Xshift, 1);
 				}
+				/*
+				 * map an xkeysym onto a utf-8 char.
+				 * allows Xvnc to read us, see utf2ksym.h
+				 */
+				if((ks & 0xff00) && ks < nelem(utf2ksym) && utf2ksym[ks] != 0)
+					ks = utf2ksym[ks];
 				keyevent(v, ks, 1);
 				/*
 				 * up event needed by vmware inside linux vnc server,
