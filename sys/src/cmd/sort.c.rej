--- sys/src/cmd/sort.c	Thu Apr 25 00:51:02 2013
+++ sys/src/cmd/sort.c	Thu Apr 25 00:51:02 2013
@@ -71,7 +71,7 @@
 	int	end2;
 
 	long	flags;
-	uchar	mapto[256];
+	uchar	mapto[1+0xffff];	/* this is not Runemax to keep this table small */
 
 	void	(*dokey)(Key*, uchar*, uchar*, Field*);
 };
@@ -95,7 +95,6 @@
 	long	mline;			/* max lines per file */
 } args;
 
-extern	int	latinmap[];
 extern	Rune*	month[12];
 
 void	buildkey(Line*);
@@ -1293,15 +1292,26 @@
 		/*
 		 * for characters out of range,
 		 * the table does not do Rflag.
-		 * ignore is based on mapto[255]
+		 * ignore is based on mapto[nelem(f->mapto)]
 		 */
 		if(c != 0 && c < nelem(f->mapto)) {
 			c = f->mapto[c];
 			if(c == 0)
 				continue;
-		} else
+		} else {
 			if(f->mapto[nelem(f->mapto)-1] == 0)
 				continue;
+			/*
+			 * consider building maps as necessary
+			 */
+			if(f->flags & Fflag)
+				c = tolowerrune(tobaserune(c));
+			if(f->flags & Dflag && !isalpharune(c) &&
+			    !isdigitrune(c) && !isspacerune(c))
+				continue;
+			if((f->flags & Wflag) && isspacerune(c))
+				continue;
+		}
 
 		/*
 		 * put it in the key
@@ -1430,7 +1440,8 @@
 	k->klen = cl;
 
 	if(args.vflag) {
-		write(2, l->line, l->llen);
+		if(write(2, l->line, l->llen) != l->llen)
+			exits("write");
 		for(i=0; i<k->klen; i++) {
 			fprint(2, " %.2x", k->key[i]);
 			if(k->key[i] == 0x00 || k->key[i] == 0xff)
@@ -1466,7 +1477,7 @@
 void
 makemapd(Field *f)
 {
-	int i, j, c;
+	int i, c;
 
 	for(i=0; i<nelem(f->mapto); i++) {
 		c = i;
@@ -1480,24 +1491,12 @@
 			if(!(c == ' ' || c == '\t' ||
 			    (c >= 'a' && c <= 'z') ||
 			    (c >= 'A' && c <= 'Z') ||
-			    (c >= '0' && c <= '9'))) {
-				for(j=0; latinmap[j]; j+=3)
-					if(c == latinmap[j+0] ||
-					   c == latinmap[j+1])
-						break;
-				if(latinmap[j] == 0)
+			    (c >= '0' && c <= '9'))){
+				if(!isupperrune(c = toupperrune(c)))
 					c = -1;
 			}
-		if((f->flags & Fflag) && c >= 0) {
-			if(c >= 'a' && c <= 'z')
-				c += 'A' - 'a';
-			for(j=0; latinmap[j]; j+=3)
-				if(c == latinmap[j+0] ||
-				   c == latinmap[j+1]) {
-					c = latinmap[j+2];
-					break;
-				}
-		}
+		if((f->flags & Fflag) && c >= 0)
+			c = toupperrune(tobaserune(c));
 		if((f->flags & Rflag) && c >= 0 && i > 0 && i < Runeself)
 			c = ~c & 0xff;
 		if(c < 0)
@@ -1512,41 +1511,6 @@
 		}
 	}
 }
-
-int	latinmap[] =
-{
-/*	lcase	ucase	fold	*/
-	L'à',	L'À',	L'A',	
-	L'á',	L'Á',	L'A',	
-	L'â',	L'Â',	L'A',	
-	L'ä',	L'Ä',	L'A',	
-	L'ã',	L'Ã',	L'A',	
-	L'å',	L'Å',	L'A',	
-	L'è',	L'È',	L'E',	
-	L'é',	L'É',	L'E',	
-	L'ê',	L'Ê',	L'E',	
-	L'ë',	L'Ë',	L'E',	
-	L'ì',	L'Ì',	L'I',	
-	L'í',	L'Í',	L'I',	
-	L'î',	L'Î',	L'I',	
-	L'ï',	L'Ï',	L'I',	
-	L'ò',	L'Ò',	L'O',	
-	L'ó',	L'Ó',	L'O',	
-	L'ô',	L'Ô',	L'O',	
-	L'ö',	L'Ö',	L'O',	
-	L'õ',	L'Õ',	L'O',	
-	L'ø',	L'Ø',	L'O',	
-	L'ù',	L'Ù',	L'U',	
-	L'ú',	L'Ú',	L'U',	
-	L'û',	L'Û',	L'U',	
-	L'ü',	L'Ü',	L'U',	
-	L'æ',	L'Æ',	L'A',	
-	L'ð',	L'Ð',	L'D',	
-	L'ñ',	L'Ñ',	L'N',	
-	L'ý',	L'Ý',	L'Y',	
-	L'ç',	L'Ç',	L'C',	
-	0,
-};
 
 Rune*	month[12] =
 {
