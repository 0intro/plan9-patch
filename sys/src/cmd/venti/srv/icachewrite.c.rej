--- sys/src/cmd/venti/srv/icachewrite.c	Tue Sep 18 02:49:24 2007
+++ sys/src/cmd/venti/srv/icachewrite.c	Tue Sep 18 02:49:24 2007
@@ -65,12 +75,10 @@
 
 	bsize = 1<<is->blocklog;
 	iefirst = *pie;
-	addr = is->blockbase + ((u64int)(hashbits(iefirst->score, 32) /
-		ix->div - is->start) << is->blocklog);
+	addr = ie2diskaddr(ix, is, iefirst);
 	nbuf = 0;
 	for(l = &iefirst->nextdirty; (ie = *l) != nil; l = &(*l)->nextdirty){
-		naddr = is->blockbase + ((u64int)(hashbits(ie->score, 32) /
-			ix->div - is->start) << is->blocklog);
+		naddr = ie2diskaddr(ix, is, ie);
 		if(naddr - addr >= Bufsize)
 			break;
 		nbuf = naddr - addr;
@@ -135,8 +143,7 @@
 
 		for(l=&chunk; (ie=*l)!=nil; l=&ie->nextdirty){
 again:
-			naddr = is->blockbase + ((u64int)(hashbits(ie->score,
-				32) / ix->div - is->start) << is->blocklog);
+			naddr = ie2diskaddr(ix, is, ie);
 			off = naddr - addr;
 			if(off+bsize > nbuf){
 				fprint(2, "%s: whoops! addr=0x%llux nbuf=%ud "
